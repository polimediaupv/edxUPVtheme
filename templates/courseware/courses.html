<%!
  import json
  from django.utils.translation import ugettext as _
  from microsite_configuration import microsite
  from openedx.core.lib.js_utils import escape_json_dumps
  from django.utils.timezone import UTC
  import pytz
  from django.utils import timezone
  import datetime
  from datetime import datetime as dt
%>
<%inherit file="../main.html" />
<%
  course_discovery_enabled = settings.FEATURES.get('ENABLE_COURSE_DISCOVERY')
%>

<%namespace name='static' file='../static_content.html'/>

% if course_discovery_enabled:
<%block name="header_extras">
  % for template_name in ["course_card", "filter_bar", "filter", "facet", "facet_option"]:
  <script type="text/template" id="${template_name}-tpl">
      <%static:include path="discovery/${template_name}.underscore" />
  </script>
  % endfor
  <%static:require_module module_name="js/discovery/discovery_factory" class_name="DiscoveryFactory">
    DiscoveryFactory(
      ${ escape_json_dumps(course_discovery_meanings) | n },
      getParameterByName('search_query')
    );
  </%static:require_module>
</%block>
% endif

<%block name="pagetitle">${_("Courses")}</%block>

<section class="find-courses">
  <section class="courses-container">
	  
    <div class="courses${'' if course_discovery_enabled else ' no-course-discovery'}" role="region" aria-label="${_('List of Courses')}">
      <ul class="courses-listing">
	    <%
                future=[]
                past=[]
                current=[]
                archived=[]
                closed=[]
                reordered=[]
                for course in courses:
                    now = dt.now(UTC())
                    start = course.enrollment_start or dt.min.replace(tzinfo=pytz.UTC)
                    end = course.enrollment_end or dt.max.replace(tzinfo=pytz.UTC)

                    canenroll = False

                    if start < now < end:
                        canenroll = True
                    endif


                    if course.end == None:
                        course.end = timezone.now() + datetime.timedelta(days=1)
                    if course.start > timezone.now():
                        future.append(course)
                    elif course.end > timezone.now():
                        current.append(course)
                    elif canenroll:
                        archived.append(course)
                    else:
                        closed.append(course)
                future = sorted(future, key=lambda course: course.start)
                current = sorted(current, key=lambda course: course.start,reverse=True)
                archived = sorted(archived, key=lambda course: course.start, reverse=True)
                closed = sorted(closed, key=lambda course: course.start, reverse=True)
                reordered = future + current + archived + closed

            %>

	%for course in reordered:
<%
		  now = dt.now(UTC())
        	  start = course.enrollment_start or dt.min.replace(tzinfo=pytz.UTC)
        	  end = course.enrollment_end or dt.max.replace(tzinfo=pytz.UTC)

        	  canenroll = False

                  if start < now < end:
                     canenroll = True
                  endif
%>
		% if course.display_org_with_default.lower() != "poc" and canenroll :
                       <li class="courses-listing-item">
                               <%include file="../course.html" args="course=course" />
                       </li>
		% endif
        %endfor      
     </ul>
    </div>  
      <script type="text/javascript">
	    $(".edxorglink").unbind().click(function(event) {
	        event.preventDefault();
	        console.log("adsfa");
	        if (checkCookie(this.attributes['courseid'].value) == "True")
	        {
	            window.location.href=this.attributes['edxorg'].value;
	        }
	        else
	        {
	            SetCookie(this.attributes['courseid'].value,"True",30);
	            window.location.href=this.attributes['local'].value
	        }
	        return false;
	    });

            $(function() {

  	      $("li.courses-listing-item").each(function(){
	         entidad = $(this).find("p.university")[0].innerHTML;
	         if (entidad == 'edxorg') {
	            $(this).find("p.university")[0].innerHTML='edX';
	         }
	      });
            });
	</script>  
  </section>
</section>
