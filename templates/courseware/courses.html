<%! 
  from django.utils.translation import ugettext as _
  from microsite_configuration import microsite
  from django.utils.timezone import UTC
  import pytz
  from django.utils import timezone
  import datetime
  from datetime import datetime as dt
%>
<%inherit file="../main.html" />

<%namespace name='static' file='../static_content.html'/>

<%block name="pagetitle">${_("Courses")}</%block>
<%
  platform_name = microsite.get_value('platform_name', settings.PLATFORM_NAME)

  if self.stanford_theme_enabled():
    course_index_overlay_text = _("Explore free courses from {university_name}.").format(university_name="Stanford University")
    logo_file = static.url('themes/stanford/images/seal.png')
    logo_alt_text = "Stanford Seal Logo"

  else:
    course_index_overlay_text = microsite.get_value('course_index_overlay_text', _("Explore courses from {platform_name}.").format(platform_name=platform_name))

    if settings.FEATURES.get('IS_EDX_DOMAIN', False):
      # For some reason, `static.url('images/edx-theme/edx-logo-bw.png')` breaks template rendering.
      default_image_url = settings.STATIC_URL + 'images/edx-theme/edx-logo-bw.png'
    else:
      default_image_url = settings.STATIC_URL + 'images/default-theme/logo-large.png'

    logo_file = microsite.get_value(
      'course_index_overlay_logo_file', default_image_url
    )

    logo_alt_text = _("{platform_name} Logo").format(platform_name=platform_name)
%>

<section class="find-courses">

  <header class="search">
    <div class="inner-wrapper main-search">
    </div>
  </header>

  <section class="container">
    <section class="courses">
      <ul class="courses-listing">
	    <%
                future=[]
                past=[]
                current=[]
                archived=[]
                closed=[]
                reordered=[]
                for course in courses:
                    now = dt.now(UTC())
                    start = course.enrollment_start or dt.min.replace(tzinfo=pytz.UTC)
                    end = course.enrollment_end or dt.max.replace(tzinfo=pytz.UTC)

                    canenroll = False

                    if start < now < end:
                        canenroll = True
                    endif


                    if course.end == None:
                        course.end = timezone.now() + datetime.timedelta(days=1)
                    if course.start > timezone.now():
                        future.append(course)
                    elif course.end > timezone.now():
                        current.append(course)
                    elif canenroll:
                        archived.append(course)
                    else:
                        closed.append(course)
                future = sorted(future, key=lambda course: course.start)
                current = sorted(current, key=lambda course: course.start,reverse=True)
                archived = sorted(archived, key=lambda course: course.start, reverse=True)
                closed = sorted(closed, key=lambda course: course.start, reverse=True)
                reordered = future + current + archived + closed

            %>

	%for course in reordered:
<%
		  now = dt.now(UTC())
        	  start = course.enrollment_start or dt.min.replace(tzinfo=pytz.UTC)
        	  end = course.enrollment_end or dt.max.replace(tzinfo=pytz.UTC)

        	  canenroll = False

                  if start < now < end:
                     canenroll = True
                  endif
%>
		% if course.display_org_with_default.lower() != "poc" and canenroll :
                       <li class="courses-listing-item">
                               <%include file="../course.html" args="course=course" />
                       </li>
		% endif
        %endfor
      </ul>
      <script type="text/javascript">
                $(".edxorglink").unbind().click(function(event) {
                    event.preventDefault();
                    console.log("adsfa");
                    if (checkCookie(this.attributes['courseid'].value) == "True")
                    {
                        window.location.href=this.attributes['edxorg'].value;
                    }
                    else
                    {
                        SetCookie(this.attributes['courseid'].value,"True",30);
                        window.location.href=this.attributes['local'].value
                    }
                    return false;
                  });
      </script>
    </section>
  </section>

</section>
